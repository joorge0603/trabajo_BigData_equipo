---
title: "Los piratería desde 1993 hasta nuestros días"
author: "Teodoro D'Agostino(tedagar@alumni.uv.es)  \n\n Jorge González(jorgonan@alumni.uv.es)  \n \n Aurora Lloret(aullohe@alumni.uv.es). \n\n Universitat de València"
date: "Diciembre de 2021 (actualizado el `r format(Sys.time(), '%d-%m-%Y')`)"
output:
  html_document:
    css: "./assets/my_css_file.css"
    theme: cosmo
    highlight: textmate 
    toc: true
    toc_depth: 3 
    toc_float: 
      collapsed: true
      smooth_scroll: true
    self_contained: true
    number_sections: false
    df_print: kable
    code_download: true
    code_folding: "hide"
editor_options: 
  chunk_output_type: console
bibliography: references.bib
---

```{r packages-setup, include = FALSE}
library(tidyverse)
library(klippy)  #- remotes::install_github("rlesur/klippy")
library(knitr)
```

```{r chunk-setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE, 
                      #results = "hold",
                      cache = FALSE, cache.path = "/caches/", comment = "#>",
                      #fig.width = 7, #fig.height= 7,   
                      #out.width = 7, out.height = 7,
                      collapse = TRUE,  fig.show = "hold",
                      fig.asp = 0.828, out.width = "90%", fig.align = "center")
knitr::opts_chunk$set(dev = "png", dev.args = list(type = "cairo-png"))
```

```{r options-setup, include = FALSE}
options(scipen = 999) #- para quitar la notación científica
options("yaml.eval.expr" = TRUE) 
```

```{r klippy, echo = FALSE}
klippy::klippy(position = c("top", "right")) #- remotes::install_github("rlesur/klippy")
```

<hr class="linea-black">

<!-- El párrafo de abajo has de dejarlo casi igual, solo HAS de SUSTITUIR "perezp44" por tu usuario de Github-->

Trabajo elaborado para la asignatura "Programación y manejo de datos en la era del Big Data" de la Universitat de València durante el curso 2021-2022. El repo del trabajo está [aquí](https://github.com/joorge0603/trabajo_BigData_equipo){target="_blank"}.

<!-- El párrafo de abajo has de dejarlo exactamente igual, NO has de cambiar nada-->

La página web de la asignatura y los trabajos de mis compañeros pueden verse [aquí](https://perezp44.github.io/intro-ds-21-22-web/07-trabajos.html){target="_blank"}.

<hr class="linea-black">

```{r, include=FALSE}
library(tidyverse)
library(gganimate)
library(gt)
library(patchwork)
library(hrbrthemes)
library(summarytools)
library(knitr)
library(mapdata)
library(maps)
library(ggrepel)
library(lubridate)
library(plotly)
library(readr)
library(ggplot2)
library(png)
library(dplyr)
library(grid)
```

# 1. Introducción

En este trabajo trataremos de extraer algunas conclusiones y ayudar al lector a comprender algunos datos sobre la piratería marítima en el mundo actual. Nuestro dataset se basa en el que se puede econtrar [aquí](https://www.kaggle.com/n0n5ense/global-maritime-pirate-attacks-19932020). La referencia completa es esta [@dataset].

<br>

## 1.1 Contexto de la piratería marina

A pesar de que la mención de piratas evoca en la mente de la mayoría de nosotros nociones de rudos aventureros delinquiendo por sus vidas en las aguas turquesas de algún paraíso tropical siglos atrás, la pitarería marina es un problema actual con serias implicaciones sociales y económicas, que ha ganado terreno en el discurso mediático y la investigación académica a partir de casos trágicos como el secuestro de un barco ruso en la costa somalí en septiembre de 2008, u otro evento similar siete meses después con el carguero Maersk Alabama, que fue resuelto con el rescate por parte del ejército norteamericano de los rehenes tomados [@haywood2013maritime].

<br>

![*La imagen que suele venirnos a la mente cuando pensamos en piratería.*](imagenes/piratas.jpg){width="width" height="height"}

No existe una única definición clara de qué constituye un ataque pirata, lo cual dificulta su estudio y la formulación de políticas adecuadas para su resolución [@Dillon_2005]. Resulta útil, por tanto, atender a los detalles de cada evento susceptible de ser clasificado como acto de piratería y ajustar la respuesta institucional al problema a los distintos tipos de ataques que pueden producirse. Este dataset resulta de utilidad justamente por permitir diferenciar entre distintas variedades de ataque. Lo que une todos ellos viene recogido por la definición que proporciona el diccionario de Oxford del término piracy [@oxford]:

> *The action of committing robbery, kidnap, or violence at sea or from the sea without lawful authority, especially by one vessel against another; an instance of this.*

La pitratería en el mundo actual es una lacra para el desarrollo, con un coste económico estimado entre los 7 y 12 mil millones de dólares americanos al año, o incluso más [@Bowden_2010]. Sin embargo, es probable que las peores consecuancias sean las humanitarias, que se dejan sentir especialmente en aquellos paíse subsdesarrollados en cuyas aguas se emplazan la mayoría de ataques. Es importante considerar que la mayoría de actos de piratería suceden en un contexto mayor de violencia y desorden que casi siempre va de la mano de altos niveles de corrupción y llega a incluir guerras civiles, y que como mínimo condiciona la vida de la población local a causa de las distorsiones que genera en los sectores pesquero y de explotación minera y petrolífera, a menudo principales fuentes de riqueza de las comunidades costeras de estos países [@Nincic_2009][@Fu_2010].

Nuestro análisis va a permitir identificar algunas de las tendencias que han definido la evolución de la piratería en estos últimos años, especialmente en lo referente a prevalencia de los tipos de ataques y movimiento de las "zonas calientes" de la piratería internacional. También vamos a contextualizar esta información con datos de carácter económico, social y político.

# 2. Manejo de los datos 

#### {.tabset}

```{r, eval = TRUE, echo=FALSE}
#Primero lo evaluamos pero no los mostramos
# DATA SOURCE: Benden, P., Feng, A., Howell, C. and Dalla Riva, G.V., 2021. Crime at Sea: A Global Database of Maritime Pirate Attacks (1993–2020). Journal of Open Humanities Data, 7, p.19. DOI: http://doi.org/10.5334/johd.39


country_codes <- read_csv("datos/country_codes.csv")

country_indicators <- read_csv("datos/country_indicators.csv")

pirate_attacks <- read_csv("datos/pirate_attacks.csv")

country_data <- full_join(country_codes, country_indicators, by = c("country" = "country"))
 

pirate_attacks <- pirate_attacks %>% mutate(year = year(date))


pirate_attacks <- pirate_attacks %>% mutate(attack_type = case_when(
  attack_type == "Boarding" ~ "Boarded", 
  TRUE ~ attack_type))

pirate_attacks <- pirate_attacks %>% mutate(vessel_status = case_when(
  vessel_status == "steaming" ~ "Steaming", 
  TRUE ~ vessel_status))

pirate_attacks <- pirate_attacks %>% mutate(vessel_type = case_when(
  vessel_type == "BULK CARRIER" ~ "Bulk Carrier", 
  TRUE ~ vessel_type))

pirate_attacks <- pirate_attacks %>% mutate(vessel_type = case_when(
  vessel_type == "CONTAINER" ~ "Container", 
  TRUE ~ vessel_type))

pirate_attacks <- pirate_attacks %>% mutate(vessel_type = case_when(
  vessel_type == "PRODUCT TANKER" ~ "Product Tanker", 
  TRUE ~ vessel_type))

pirate_attacks <- pirate_attacks %>% mutate(vessel_type = case_when(
  vessel_type == "Offshore Supply ship" ~ "Offshore Supply Ship", 
  TRUE ~ vessel_type))

pirate_attacks <- pirate_attacks %>% mutate(vessel_type = case_when(
  vessel_type == "OFFSHORE SUPPLY SHIP" ~ "Offshore Supply Ship", 
  TRUE ~ vessel_type))

pirate_attacks <- pirate_attacks %>% mutate(vessel_type = case_when(
  vessel_type == "Offshore Supply" ~ "Offshore Supply Ship", 
  TRUE ~ vessel_type))

rm(country_codes, country_indicators)

pirate_attacks <- pirate_attacks %>% mutate(year = as.integer(year))

full_by_nearest <- full_join(pirate_attacks, country_data, by = c("nearest_country" = "country", "year" = "year"))|> filter(!is.na(longitude)) 

```

##### **Estructura de los datos**

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

# numero de ataques

n_attacks <- pirate_attacks |>  nrow() |> as.integer()


# periodo de años: desde first_year hasta last_year

first_year <- pirate_attacks |> select(year) |> slice_head(n = 1) |> as.integer()

last_year <- pirate_attacks |> select(year) |>  slice_tail(n = 1) |> as.integer()
```

Vamos a analizar un dataset que contiene información sobre `r n_attacks` ataques pirata ocurridos entre `r first_year` y `r last_year`. Esta tabla permite apreciar el tipo de datos que tenemos:

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
library(DT)

datatable(pirate_attacks, rownames = FALSE, filter="top", options = list(pageLength = 10, scrollX=T))

```

##### **Haciendo los datos tidy**

Aquí mostraremos como hemos tratado los datos para poder llevar a cabo nuestros análisis. Para ello hemos unido dos de los datasets que teníamos y hemos tratado de limpiar los datos. Las principales labores han consistido en corregir inconsistencias en los nombres de tipos de ataques, barcos... además de cuestiones algo más técnicas de manipulación de la expresión de fecha y tipo de variable cuando lo hemos requerido.

```{r, eval = FALSE}
#Ahora mostramos el código 
# DATA SOURCE: Benden, P., Feng, A., Howell, C. and Dalla Riva, G.V., 2021. Crime at Sea: A Global Database of Maritime Pirate Attacks (1993–2020). Journal of Open Humanities Data, 7, p.19. DOI: http://doi.org/10.5334/johd.39

country_codes <- read_csv("datos/country_codes.csv")

country_indicators <- read_csv("datos/country_indicators.csv")

pirate_attacks <- read_csv("datos/pirate_attacks.csv")

country_data <- full_join(country_codes, country_indicators, by = c("country" = "country"))
 

pirate_attacks <- pirate_attacks %>% mutate(year = year(date))


pirate_attacks <- pirate_attacks %>% mutate(attack_type = case_when(
  attack_type == "Boarding" ~ "Boarded", 
  TRUE ~ attack_type))

pirate_attacks <- pirate_attacks %>% mutate(vessel_status = case_when(
  vessel_status == "steaming" ~ "Steaming", 
  TRUE ~ vessel_status))

pirate_attacks <- pirate_attacks %>% mutate(vessel_type = case_when(
  vessel_type == "BULK CARRIER" ~ "Bulk Carrier", 
  TRUE ~ vessel_type))

pirate_attacks <- pirate_attacks %>% mutate(vessel_type = case_when(
  vessel_type == "CONTAINER" ~ "Container", 
  TRUE ~ vessel_type))

pirate_attacks <- pirate_attacks %>% mutate(vessel_type = case_when(
  vessel_type == "PRODUCT TANKER" ~ "Product Tanker", 
  TRUE ~ vessel_type))

pirate_attacks <- pirate_attacks %>% mutate(vessel_type = case_when(
  vessel_type == "Offshore Supply ship" ~ "Offshore Supply Ship", 
  TRUE ~ vessel_type))

pirate_attacks <- pirate_attacks %>% mutate(vessel_type = case_when(
  vessel_type == "OFFSHORE SUPPLY SHIP" ~ "Offshore Supply Ship", 
  TRUE ~ vessel_type))

pirate_attacks <- pirate_attacks %>% mutate(vessel_type = case_when(
  vessel_type == "Offshore Supply" ~ "Offshore Supply Ship", 
  TRUE ~ vessel_type))

rm(country_codes, country_indicators)

pirate_attacks <- pirate_attacks %>% mutate(year = as.integer(year))

full_by_nearest <- full_join(pirate_attacks, country_data, by = c("nearest_country" = "country", "year" = "year"))|> filter(!is.na(longitude)) 

```

####

Para que sirva de primera aproximación, en este globo terráqueo se pueden explorar los ataques registrados, el país más cercano a donde se produjeron y su año.

```{r}
library("covid19.analytics")
library("plotly")

df2 <- full_by_nearest |> separate(date, c("year", "month", "day"), "-" ) |> dplyr::select("year","longitude","latitude","country_name") |> mutate(year = as.numeric(year)) |> rename(Province = year) |> rename(Country = country_name)|> rename(Long = longitude)|> rename(Lat = latitude) |> dplyr::select(4,1,2,3) |> as.data.frame()

globemap <- live.map(data = df2, select.projctn = FALSE, title = "", no.legend = TRUE)

globemap <- globemap %>% layout(title = "") 

htmltools::div(globemap, align = "center" )
```

# 3. Ataques piratas

## 3.1 Evolución temporal

```{r, eval = TRUE}
library(ggplot2)
library(png)
library(dplyr)
library(grid)


#barco <- readPNG("imagenes/barco.png")

#Ataques totales a lo largo de los años

at_totales <- pirate_attacks %>% group_by(year) %>% summarise(total= n()) 



#representamos 


p1 <- ggplot(data = at_totales, aes(year, total)) + geom_line(color="darkblue") + geom_point(color="darkblue") + theme_minimal() + geom_text(aes(y = total, ymax = total, label = total), position = position_dodge(width = 0.9), size=3, vjust=-0.8, hjust=0.8 ,col="black") + theme_classic() + labs(title = "Total de ataques",
    subtitle = "(1993-2020)",
    x = "Años",
    y = "Nº de ataques") + theme(plot.title = element_text(size = 20, face = "bold", hjust = 0.5),plot.subtitle = element_text(size = 20, hjust = 0.5))

#Añadimos una imagen
img <- readPNG("imagenes/barco.png", FALSE)
marca <- rasterGrob(img, interpolate=F,height=unit(3, "cm"),hjust=-1.30, vjust=-0.5)
p1 + annotation_custom(marca,xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf)
marca


year_at_max <- at_totales |> select(year) %>%  slice_max(order_by= year, n = 1) |> as.integer()

at_max <- at_totales |> select(total) %>% slice_max(order_by= total, n = 1) |> as.integer()



```

Podemos ver como han ido evolucionando los ataques totales a lo largo de los años. Su máximo fue en el año `r year_at_max` con un total de `r at_max` ataques. En la actualidad se han reducido debido a 190 ataques. Los ataques a los barcos ponen en peligro la vida de la tripulación, además afectan al comercio internacional. A lo largo del tiempo la preoucupación ha crecido debido a que los asaltantes cada vez hacen más uso de las armas. Debido a esto la pirateria marina ha pasado por distintas fases de regulación en el Derecho Internacional. Acciones como el uso de patrulleras han ayudado en la disminución de los ataques.

## 3.2 Evolución geográfica

```{r, eval = TRUE}

#intento de mapa
library(mapdata)
library(ggplot2)
library(maps)
library(ggrepel)
library(gganimate)

library(plotly)

# Guardamos la información en un nuevo dataframe llamado mapa_mundo

at_mapa <- pirate_attacks %>% select(longitude, latitude, attack_type, year)

mapa_mundo <- map_data("world")

p <- mapa_mundo %>%
  ggplot() +
  geom_polygon(aes( x= long, y = lat, group = group),
               fill = "white",
               color = "black") +
  theme_minimal() +
  theme(
    axis.line = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_rect(colour= "black", size= 1)) +
  geom_point(data=at_mapa, aes(longitude, latitude),
             color= "darkgoldenrod1", size=2) +
  labs(title = "Concentración de los ataques",
    subtitle = "(1993-2020)") + theme(plot.title = element_text(size = 20, face = "bold", hjust = 0.5),plot.subtitle = element_text(size = 20, hjust = 0.5)) +
  coord_fixed (xlim= c(-200,200),
              ylim= c(-58,90),
              ratio = 1.3) + transition_time(year) + labs(caption = "Year: {frame_time}") + theme(panel.background = element_rect(fill = "lightblue2")) 


animate(p, width = 700, height = 432, fps = 1, duration = 15, rewind = FALSE)
```

Los ataques se han concentrado sobre todo en el Sudeste asiático y el subcontinente indio, África y América del Sur, Central y las Aguas del Caribe. Podemos ver que durante los primeros años (1993-2008) hay una mayor concentración de los ataques en el estrecho de Malasia, sin embargo comienzan a reducirse debido al aumento de la vigilancia maritima. En Indonesia la Policía Marina de Indondesia(IMP) actúa para evitar más ataques patrullando cerca de las costas, por lo que ha establecido ciertos puntos de mayor protección.

En cuanto a África podemos ver que en el golfo de Guinea aproximadamente desde 1999 ha habido una gran concentración de ataques. En Nigeria los piratas son violentos y van armados. Estas aguas se consideran de alto riesgo. Debido a la guerra civil en Yemén en esta zona se suelen concentrar ataques a barcos que no tienen porque estar directamente relacionados con la piratería. Por último, en la actualidad se concentran menos ataques en Kenia, Tanzania, Océano Índico..., sin embargo como se puede ver, en el pasado se concentraron la mayoría de los ataques.

Finalmente, América del Sur también ha sido una zona de concentración de ataques, aunque con menor relevancia que los comentados anteriormente. Muchas de estas conclusiones se ven reflejadas, quizás con mayor claridad, en la siguiente gráfica dinámica:

```{r}
full_by_nearest <- full_join(pirate_attacks, country_data, by = c("nearest_country" = "country", "year" = "year"))|> filter(!is.na(longitude))

df <- full_by_nearest |> drop_na(region) |> dplyr::select(year, region) |> unite("id", c(1:2), sep = "_", remove = TRUE)|>  group_by(id) |> mutate(nattacks = n()) |> ungroup() |> distinct() |> separate(id, c("year", "region"), "_" ) |> mutate(year = as.numeric(year)) %>% mutate(region = case_when(
  region == "East Asia & Pacific" ~ "Asia del Este & Pacífico",
  region == "Latin America & Caribbean" ~ "Latino América & Caribe",
  region == "South Asia" ~ "Sur de Asia",
  region == "Sub-Saharan Africa" ~ "África Sub-Sahariana",
  TRUE ~ region))


accumulate_by <- function(dat, var) {
  var <- lazyeval::f_eval(var, dat)
  lvls <- plotly:::getLevels(var)
  dats <- lapply(seq_along(lvls), function(x) {
    cbind(dat[var %in% lvls[seq(1, x)], ], frame = lvls[[x]])
  })
  dplyr::bind_rows(dats)
}


fig <- df 
fig <- fig %>% accumulate_by(~year)


fig <- fig %>%
  plot_ly(
    x = ~year, 
    y = ~nattacks,
    split = ~region,
    frame = ~frame, 
    type = 'scatter',
    mode = 'lines', 
    fill = 'tozeroy',
    line = list(simplyfy = F)
  )
fig <- fig %>% layout(
  xaxis = list(
    title = "Año",
    zeroline = F
  ),
  yaxis = list(
    title = "Número de ataques",
    zeroline = F
  )
)
fig <- fig %>% animation_opts(
  frame = 100, 
  transition = 0, 
  redraw = FALSE
)
fig <- fig %>% animation_slider(
  currentvalue = list(
    prefix = "Año "
  )
)

htmltools::div(fig, align = "center" )

```

## 3.3 Tipos de ataques 

#### {.tabset}

Existen diferentes tipos de ataques como por ejemplo los abordajes, secuestros, explosiones... vamos a ver cuáles son más frecuentes. Para este análisis hemos excluido los ataques de los cuales no hay información en está categoría (120 ataques).

##### **Tipos más frecuentes**

```{r, fig.width=7, fig.height=6}
#Ataques según tipo: cantidad total de los ataques según el tipo entre 1993 y 2020 (en el grafico poner los numeros en las barras)

library(ggthemes)

a <- pirate_attacks %>% select(year, attack_type) %>% group_by(year) %>%  count(attack_type) %>% filter(year < 2000) %>% group_by(attack_type) %>% summarise(n = sum(n)) %>% drop_na()
period <- c("1993-1999","1993-1999","1993-1999","1993-1999")
a <- data.frame(period, a)  

b <- pirate_attacks %>% select(year, attack_type) %>% group_by(year) %>%  count(attack_type) %>% filter(year > 1999 & year < 2007, !attack_type == "Detained") %>% group_by(attack_type) %>% summarise(n = sum(n)) %>% drop_na()
period <- c("2000-2006","2000-2006","2000-2006",
            "2000-2006")
b <- data.frame(period, b)

c <- pirate_attacks %>% select(year, attack_type) %>% group_by(year) %>%  count(attack_type) %>% filter(year > 2006 & year < 2014) %>% group_by(attack_type) %>% summarise(n = sum(n)) %>% drop_na()
period <- c("2007-2013","2007-2013","2007-2013","2007-2013")
c <- data.frame(period, c)

d <- pirate_attacks %>% select(year, attack_type) %>% group_by(year) %>%  count(attack_type) %>% filter(year > 2013) %>% group_by(attack_type) %>% summarise(n = sum(n)) %>% drop_na()
period <- c("2014-2020","2014-2020","2014-2020","2014-2020",
            "2014-2020")
d <- data.frame(period, d)

at <- rbind(a,b,c,d) %>%  mutate(attack_type = forcats::as_factor(attack_type)) %>% mutate(attack_type = forcats::fct_reorder(attack_type, n, .desc = TRUE))

  


ggplot(data=at, aes(attack_type, n)) + 
  geom_bar(stat="identity", fill="MediumSlateBlue") + 
  theme_classic() + 
  geom_text(aes(y = n, label = n), 
            position = position_dodge(width = 0.9), size=3,
            vjust=-0.1, hjust=0.5 ,col="black", fontface = "bold") +
  labs(title = "Tipos de ataques",
    subtitle = "(1993-2020)",
    x = "Tipos de ataques",
    y = "Número de ataques") + 
  theme(plot.title = element_text(size = 20, face = "bold", 
                                  hjust = 0.5), 
        plot.subtitle = element_text(size = 20, hjust = 0.5)) +
  facet_wrap(vars(period)) +
  scale_x_discrete(labels=c("Abordaje","Intento","Secuestro",
                            "Duda", "Explosión", "Disparos")) +
  scale_y_continuous(limits = c(0, 1700))
```

Los ataques más frecuentes son los abordajes, los piratas suelen atacar los barcos mientras navegan o están anclados, además se hace especial advertencia a la noche, que es cuando más posibilidades de ser atacado hay. Por lo tanto, los barcos deben prestar vigilancia en todo momento. En menor medida pero también relevantes son los secuestros, en el pasado se llevaron a cabo varios secuestros de camiones cisterna de productos pequeños en la zona del Mar de China Meridional.Los secuestros que se empezaron a observar en 2014 no duraron más de un año. Con éxito las autoridades consiguieron atrapar a varios de los secuestradores. En la zona de África muchos de los secuestros los utilizaban para pedir rescate. A partir de ahora centraremos el análisis en los tipos más comunes: abordaje, intento y secuestro.

##### **Distribución geográfica**

Si centramos el foco en estos tres tipos de ataque y los representamos sobre el mapa, comenzamos a identificar alguna de las tendencias más importantes que vienen reflejadas en la literatura sobre piratería. Principalmente, observamos que los secuestros tienen mucha mayor importancia en el Índico occidental que en ninguna otra área. También comenzamos a observar que los ataques de secuestro e intentos fallidos son mucho más frecuentes a mayor distancia de la costa.

```{r, eval = TRUE}
library(tmap) 
library(ggplot2)
library(maps)
library(ggthemes)

data(World)
world <- World |> filter(continent != "Antarctica") ; rm(World)

df <- pirate_attacks |> filter(attack_type == "Boarded" | attack_type == "Hijacked" | attack_type == "Attempted" )

map_by_type <- ggplot() + 
  geom_sf(data = world, color = "grey", fill = "grey", lwd = 0.2, aes(geometry = geometry)) + 
  geom_point(data = df, aes(x = longitude, y = latitude, color = attack_type), size = 0.5, alpha = 0.3) + 
  scale_color_discrete(labels = c("Intento", "Abordaje", "Secuestro")) +
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks = element_line(linetype = "blank"),
    panel.grid.major = element_line(linetype = "blank"),
    panel.grid.minor = element_line(linetype = "blank"),
    legend.title = element_text(face = "bold"),
    panel.background = element_rect(fill = NA),
    legend.key = element_rect(fill = NA),
    legend.background = element_rect(fill = NA),
    legend.position = "bottom", legend.direction = "horizontal") +labs(title = "Ataques de los tipos más frecuentes", x = NULL,
    y = NULL, colour = "Tipo de ataque")+ theme(axis.text = element_text(face = "bold",
    colour = NA, hjust = 0, vjust = 0), legend.background = element_rect(fill = "white"),
    legend.position = c(0.1, 0.3), legend.direction = "vertical") 

map_by_type 
```

El siguiente gráfico, con la distancia media a la costa de cada tipo de ataque, confirma esta intuición:

```{r message=FALSE, warning=FALSE}

df <- pirate_attacks |> filter(attack_type == "Boarded" | attack_type == "Hijacked" | attack_type == "Attempted" ) |>  group_by(attack_type) |> summarise(n = mean(shore_distance)) |> mutate(attack_type = forcats::as_factor(attack_type)) |> mutate(attack_type = forcats::fct_reorder(attack_type, n, .desc = TRUE))

ggplot(data = df) + geom_bar(mapping = aes(x = attack_type, y = n), stat = "identity", fill=c("PowderBlue", "MistyRose", "LightSteelBlue")) + theme(panel.grid.major = element_line(linetype = "blank"),
    panel.grid.minor = element_line(linetype = "blank"),
    panel.background = element_rect(fill = NA))  +
  labs(title = "Distancia media a la costa por tipo de ataque",
    x = "Tipos de ataques",
    y = "Distancia media a la costa") + theme(plot.title = element_text(size = 20, face = "bold", hjust = 0.5),         plot.subtitle = element_text(size = 20, hjust = 0.5)) + scale_x_discrete(labels=c("Intento","Secuestro","Abordaje"))
```

####

Finalmente, un vistazo a este gráfico tridimensional también permite apreciar las tendencias en la distancia a la costa según el tipo de ataque descritas previamente, además de evidenciar la concentración de los ataques en la franja tropical y en las costas de las masas continentales. De hecho, cuando se posiciona el punto de vista perpendicularmente al plano (x,y), es posible apreciar cómo los puntos perfilan el contorno de África y América del Sur.

```{r message=FALSE, warning=FALSE}
library(plotly)

df <- full_by_nearest |> filter(attack_type == "Boarded" | attack_type == "Hijacked" | attack_type == "Attempted" ) %>% 
  mutate(attack_type = case_when(
    attack_type == "Boarded" ~ "Abordaje",
    attack_type == "Hijacked" ~ "Secuestro",
    attack_type == "Attempted" ~ "Intento",
    TRUE ~ attack_type
  ))


fig3d <- plot_ly(df, x = ~longitude, y = ~latitude, z = ~shore_distance, color = ~attack_type, size = 0.2, alpha = 1)
fig3d <- fig3d %>% add_markers()

fig3d <- fig3d %>% layout(scene = list(xaxis = list(title = 'Longitud'),
                                  yaxis = list(title = 'Latitud'),
                                  zaxis = list(title = 'Distancia a la costa')))

fig3d
```

## 3.4 Estado de las embarcaciones

```{r}

at_estado <- pirate_attacks %>% select(year, vessel_status) %>% group_by(year) %>%  count(vessel_status) %>%  filter(!is.na(vessel_status)) %>% slice_max(order_by = n, n=7) %>% group_by(vessel_status) %>% summarise(h=sum(n)) %>% slice_max(order_by = h, n=11) %>%  mutate(vessel_status = forcats::as_factor(vessel_status)) %>% mutate(vessel_status = forcats::fct_reorder(vessel_status, h, .desc = FALSE))


ggplot(data=at_estado, aes(vessel_status, h)) + geom_col(fill="Thistle") + 
  coord_flip() + 
  theme_minimal() + 
  labs(title = "Estado de las embarcaciones",
    x = "Estado de la embarcación",
    y = "Número de embarcaciones") + 
  scale_x_discrete(labels=c("Anclado","Navegando", "Secuestro","Atracado","En marcha", "Estacionado", "A la deriva", "Amarrado", "Remolcado", "En tierra", "Pescando", "Repostando")) +
  theme(plot.title = element_text(size = 20, face = "bold", hjust = 0),         plot.subtitle = element_text(size = 20, hjust = 0.5),
        axis.title.x = element_text(size = 13, hjust = 1, vjust = 0),
        axis.title.y = element_text(size = 13, hjust = 1, vjust = 1)) 


```

La mayoría de las embarcaciones cuando fueron atracadas se encontraban ancladas, steaming o atracadas. La diferencia entre.... Los piratas suelen huir cuando suenan las alarmas de los barcos sin dar tiempo a ser atrapados, por lo que muchos de los incidentes resultan no denunciarse. Las autoridades ponen a disposición Imb Piracy Reporting Centre donde pueden reportar todos los incidentes que se produzcan.

## 3.5 Tipo de embarcaciones

Si centramos el foco del análisis sobre el tipo de barco atacado, para los cinco tipos más frecuentes, no podemos extraer ninguna conclusión tan clara:

```{r}
df <- pirate_attacks |> filter(vessel_type %in% c(	
  "Bulk Carrier",
  "Product Tanker",
  "Container",
  "General Cargo",
  "Chemical Tanker")) 


data(World)
world <- World |> filter(continent != "Antarctica") ; rm(World)

map_by_type2 <- ggplot() + 
  geom_sf(data = world, color = "grey", fill = "grey", lwd = 0.2, aes(geometry = geometry)) + 
  geom_point(data = df, aes(x = longitude, y = latitude, color = vessel_type), size = 0.5, alpha = 0.3) + theme(axis.ticks = element_line(linetype = "blank"),
    panel.grid.major = element_line(linetype = "blank"),
    panel.grid.minor = element_line(linetype = "blank"),
    legend.title = element_text(face = "bold"),
    panel.background = element_rect(fill = NA),
    legend.key = element_rect(fill = NA),
    legend.background = element_rect(fill = NA),
    legend.position = "bottom", legend.direction = "horizontal") +
  labs(title = "Ataques de los tipos de barco más frecuentes", 
       x = NULL,
       y = NULL, 
       colour = "Tipo de barco")+
  scale_color_discrete(labels = c("Granelero", "Buque cisterna\nquímico", "Contenedor", "Carguero", "Buque de\nproductos")) +
  theme(plot.title = element_text(hjust = 0.5),
    axis.text = element_text(face = "bold",
    colour = NA, hjust = 0, vjust = 0), 
    legend.background = element_rect(fill = "transparent"),
    legend.position = c(0.1, 0.3), 
    legend.direction = "vertical",
    legend.title = element_text(hjust = 0.5)) 

map_by_type2 

```

## 3.6 Nombres de los barcos más atacados

```{r}

nom_barc <- pirate_attacks %>% select(year, vessel_name) %>% group_by(year)  %>% count(vessel_name) %>% filter(!is.na(vessel_name)) %>% filter(!vessel_name %in% c("Unspecified","Name Withheld")) %>% group_by(vessel_name) %>% summarise(h=sum(n)) %>% slice_max(order_by = h, n=5) %>%  mutate(vessel_name = forcats::as_factor(vessel_name)) %>% mutate(vessel_name = forcats::fct_reorder(vessel_name, h, .desc = TRUE))



library(plotly)


p1 <- ggplot(data=nom_barc, aes(vessel_name, h )) + geom_col(fill="PaleVioletRed") + theme_minimal() + 
  labs(title = "Nombres de las embarcaciones más atacadas",
       x = "Nombre del barco",
       y = "Número de ataques") + theme(plot.title = element_text(size = 20, face = "bold", hjust = 0),         plot.subtitle = element_text(size = 20, hjust = 0.5),
        axis.title.x = element_text(size = 13, hjust = 1, vjust = 0),
        axis.title.y = element_text(size = 13, hjust = 1, vjust = 1))

s <- ggplotly(p1)

htmltools::div(s, align = "center" )
```

Como hemos comentado antes el Maersk Alamaba, fue secuestrado allá por el 2009, cuatro piratas somalís tomaron posesión del barco. Fue un acontecimineto importante ya que era el primer asalto que se realizaba con éxito en el Siglo XIX a un buque portador de la bandera estadounidense. En este secuestro los piratas tuvieron vigilada a la tripulación a punta de pistola. Finalmente la armada de EE.UU abatió a tres de los secuestradores.

# 4. Dataset de los Países

####  {.tabset}

##### **Información**

```{r, include=FALSE}
options(scipen = 999)

# Datos

codigos <- rio::import(here::here("datos", "country_codes.csv"))

indicadores <- rio::import(here::here("datos", "country_indicators.csv"))

paises <- full_join(codigos, indicadores, by= c("country" = "country"))

media_paises <- paises %>% group_by(country, country_name) %>% summarise(media_corrupción = mean(corruption_index, na.rm = TRUE), media_homicidios = mean(homicide_rate, na.rm = TRUE), media_militar = mean(total_military, na.rm = TRUE), media_gasto = mean(totalgr, na.rm= TRUE))
```

El siguiente dataset con el que vamos a trabajar contiene datos de una serie de indicadores para la mayoría de países del mundo. Estos países vienen agrupados en regiones, las cuales no coinciden necesariamente con los continentes. Por este motivo, resulta interesante realizar un primer análisis exploratorio de los principales indicadores del dataset por regiones, para después centrarnos más de cerca en aquellos países más relevantes

##### **Dataset**

```{r}
datatable(paises, rownames = FALSE, filter="top", options = list(pageLength = 10, scrollX=T))
```

#### 

## 4.1 Análisis por regiones

Para comenzar, realizaremos un análisis exploratorio de los principales datos de este dataset por regiones. En el mapa que se muestra a continuación se representan las distintas regiones en las que vienen agrupados los países. Cabe destacar casos como el de México. País que, aun estando en Norte América, viene recogido por la región de América latina y el Caribe.

```{r, out.width = "90%"}
media_regiones <- paises %>% 
  select(region, country_name, total_military) %>% 
  group_by(region, country_name) %>% 
  summarise(media_militar = mean(total_military, na.rm = TRUE)) %>% 
  ungroup() %>% group_by(region) %>%  
  mutate(media_militar = mean(media_militar, na.rm = TRUE)) %>% 
  mutate(iso2 = countrycode::countrycode(
    sourcevar = country_name, origin = "country.name",
    destination =  "iso2c", warn = FALSE), .after = country_name) 

mapa_mundo <- map_data("world") %>% 
  mutate(iso2 = countrycode::countrycode(
    sourcevar = region, origin = "country.name",
    destination =  "iso2c", warn = FALSE), .after = region) 

paises_mapa <- full_join(mapa_mundo, media_regiones, 
                         by= c("iso2"="iso2"))

t <- paises_mapa %>%
  ggplot() +
  geom_polygon(aes(x= long, y = lat, group = group, fill = region.y),
               color = "black") +
  labs(
    title = "Representación de los\npaíses de cada región",
    fill = "Regiones"
  ) +
  scale_fill_discrete(breaks = c("East Asia & Pacific", 
                                 "Europe & Central Asia", 
                                 "Latin America & Caribbean", 
                                 "Middle East & North Africa", 
                                 "North America", "South Asia", 
                                 "Sub-Saharan Africa"), 
                      labels = c("Asia del Este\n& Pacífico", 
                                 "Europa\n& Asia Central", 
                                 "Latino América\n& Caribe", 
                                 "Oriente Medio\n& Norte de Africa", 
                                 "América\ndel Norte", 
                                 "Sur\nde Asia", 
                                 "África\nSub-Sahariana")) +
  theme_minimal() +
  theme(plot.title = element_text(
    size = 15, face = "bold", hjust = 0.5),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(colour= "black", 
                                        size= 1, 
                                        fill = "lightblue2"),
        legend.title = element_text(face= "bold"),
        legend.position = "bottom",
        legend.direction = "horizontal") +
  coord_fixed (xlim= c(-200,200),
               ylim= c(-58,90),
               ratio = 1.3) 

t
```

### 4.1.1 Evolución índice de corrupción {.tabset}

El índice de corrupción es un indicador que mide la percepción de corrupción en cada uno de los países. Es un indicador publicado por Transparencia Internacional desde 1995, siendo 100 un nivel de corrupción nulo y 0 un nivel de corrupción muy elevado.

Es importante destacar que hasta el año 2012, el índice de corrupción venía recogido en una escala del 0 al 10. Sin embargo, en 2012 la escala fue cambiada de 0 a 100. Por este motivo, hemos realizado un cambio de escala para los años anteriores a 2012, obteniendo de este modo valores entre 0 y 100 para todo el periodo analizado.

#### **Gráfico**

A continuación podemos observar la evolución del índice de corrupción desde 1995 hasta 2019, a excepción del año 1999 en el cual no existen datos. La región mejor considerada es América del Norte, mientras que África Sub-Sahariana es la región con la peor calificación en este apartado.

Otro hecho relevante es la disminución de este índice tras la crisis financiera del 2008 y su posterior recaída en 2014 en las regiones más ricas. Este hecho puede deberse a la naturaleza de este indicador, puesto que se obtiene a través de encuestas de opinión a la ciudadanía y evaluaciones de expertos.

```{r}
media_regiones <- paises %>% 
  group_by(region, year) %>% 
  summarise(media_corrupción = mean(corruption_index, na.rm = TRUE),
            media_homicidios = mean(homicide_rate, na.rm = TRUE),
            media_militar = mean(total_military, na.rm = TRUE),
            media_gasto = mean(totalgr, na.rm= TRUE)) %>% 
  ungroup() %>% mutate(year = as.numeric(year)) %>%
  mutate(media_corrupción = ifelse(
    year<2012, media_corrupción *10, media_corrupción)) %>%
  filter(year >= 1995) %>% 
  mutate(media_regiones= is.numeric(media_regiones))

zz <- media_regiones %>%
  ggplot(aes(x = region, 
             y = media_corrupción, 
             fill= region )) +
  geom_bar(stat= "identity", 
           color = "white", 
           show.legend = FALSE) +
  geom_text(aes(label = round(media_corrupción, digits = 2)), 
            position = position_dodge(0.9), 
            vjust= 1.2, 
            size = 5, 
            color = "white")+
  scale_x_discrete(labels = c("Asia del Este\n& Pacífico", 
                              "Europa\n& Asia Central", 
                              "Latino América\n& Caribe", 
                              "Oriente Medio\n& Norte de Africa",
                              "América\ndel Norte", 
                              "Sur\nde Asia",
                              "África\nSub-Sahariana")) + 
  scale_y_continuous(labels = scales::comma) +
  theme_minimal()+
  enter_appear() +
  transition_states(year, 
                    transition_length = 1.5, 
                    state_length = 2) +
  labs(title = " Evolución del índice de corrupción por regiones  \n Año: {closest_state}", 
       subtitle = "Evolución por regiones",
       y = "",
       x = "") +
  theme(panel.grid.major.x = element_blank(),
        plot.title = element_text(size = 18, 
                                  face = "bold", 
                                  hjust = 0.5),
        plot.subtitle = element_text(size=14, 
                                     face = "plain", 
                                     hjust = 0.5)) 


animate(zz, width = 700, height = 700, fps = 2, 
        duration = 30, rewind = FALSE) 
```

#### **Tabla**

```{r}
media_regiones %>% #gtTable
  select(region, year, media_corrupción) %>% 
  filter(!year %in% c(1993, 1994,1999, NA)) %>%
  pivot_wider(names_from = "region", 
              values_from = "media_corrupción") %>% 
  gt(rowname_col = "year") %>% 
  tab_header(title = md("Índice de corrupción por regiones"),
             subtitle = md("De 1995 a 2019")) %>% 
  tab_options(heading.background.color = "midnightblue") %>%
  tab_options(heading.title.font.size = 25,
              heading.subtitle.font.size = 20, 
              column_labels.font.weight =  "bold", 
              heading.align = "center") %>% 
  tab_options(table.align = "center") %>% 
  cols_align(align = "center") %>% 
  cols_label(`East Asia & Pacific` = "Asia del Este & Pacífico",
             `Europe & Central Asia` = "Europa & Asia Central", 
             `Latin America & Caribbean` = "Latino América & Caribe",
             `Middle East & North Africa` = 
               "Oriente Medio & Norte de Africa", 
             `North America` = "América del Norte", 
             `South Asia` = "Sur de Asia", 
             `Sub-Saharan Africa` = "África Sub-Sahariana") %>% 
  fmt_number(columns= 2:8, 
             decimals = 2,
             dec_mark = ",")
```

### 4.1.2 Evolución tasa de homicidios {.tabset}

La tasa de homicidios mide el número de muertes a causa de la acción de otra persona (de manera voluntaria o no) por cada 100.000 habitantes. Este indicador nos ayuda a medir el índice de violencia de un país. Por ello, cobra especial importancia en nuestro estudio, debido a que la piratería marítima se lleva a cabo a través de actos violentos como son secuestros, robos o extorsiones. Así pues, es posible que exista una fuerte correlación entre este indicador y los ataques de piratas.

#### **Gráfico**

```{r}
media_regiones <- paises %>% group_by(region, year) %>%
  summarise(media_corrupción = mean(corruption_index, na.rm = TRUE),
            media_homicidios = mean(homicide_rate, na.rm = TRUE),
            media_militar = mean(total_military, na.rm = TRUE),
            media_gasto = mean(totalgr, na.rm= TRUE)) %>%
  ungroup() %>% mutate(year = as.numeric(year))

bb <- media_regiones %>%
  filter(!year %in% c(2019, NA)) %>%
  ggplot(aes(x= year, y= media_homicidios)) + 
  labs(title = "Evolución tasa de homicidios\npor regiones",
       x= "Año",
       y= "Índice de homicidios medio",
       color = "Regiones") +
  geom_point(aes(color= region), size= 3) +
  geom_line(aes(color= region), size= 1.5) + 
  scale_color_manual(values= c("red", "blue", "green", "black",
                               "yellow", "orange", "midnightblue"),
                     labels = c("Asia del Este\n&\nPacífico",
                                "Europa\n&\nAsia Central",
                                "Latino América\n&\nCaribe",
                                "Oriente Medio\n&\nNorte de Africa",
                                "América\ndel\nNorte",
                                "Sur\nde\nAsia",
                                "África\nSub-Sahariana"))+
  theme_minimal() +
  theme(plot.title = element_text(size = 20, face = "bold",
                                  hjust = 0.5),
        axis.title.x = element_text(size = 13, hjust = 1,
                                    vjust = 0),
        axis.title.y = element_text(size = 13, hjust = 1, vjust = 1),
        legend.title = element_text(face = "bold")) +
  transition_reveal(year) + 
  view_follow()

bb #gganimate  
```

El uso de gráficos de líneas animados es una buena herramienta para analizar la evolución de una variable de forma dinámica y sencilla. Para la tasa de homicidios, extraemos que para todo el periodo la región con la mayor tasa ha sido Latino América y el Caribe y África Sub-Sahariana. Sin embargo, en el caso de este último, este índice se ha ido reduciendo año tras año.

En lo que respecta al resto de regiones, han mantenido su nivel constante a lo largo del periodo. Destaca el caso de Oriente Medio y el Norte de África, cuyo índice ha sido y es el menor. Resulta sorprendente ya que esta región la forman países que durante el periodo han estado en guerra, como es el caso de Libia. Detrás de este fenómeno es posible que exista una incorrecta medición o la falta de datos que realmente describan la situación de estos países.

#### **Tabla**

```{r}
media_regiones %>% #gtTable
  select(region, year, media_homicidios) %>%
  filter(!year %in% c(2019, NA)) %>% 
  pivot_wider(names_from = "region", values_from = "media_homicidios") %>% 
  gt(rowname_col = "year") %>% 
  tab_header(title = md("Índice de homicidios por regiones"),
             subtitle = md("De 1993 a 2018")) %>% 
  tab_options(heading.background.color = "seagreen") %>%
  tab_options(heading.title.font.size = 25,
              heading.subtitle.font.size = 20,
              column_labels.font.weight =  "bold",
              heading.align = "center") %>% 
  tab_options(table.align = "center") %>% 
  cols_align(align = "center") %>% 
  cols_label(`East Asia & Pacific` = "Asia del Este & Pacífico",
             `Europe & Central Asia` = "Europa & Asia Central", 
             `Latin America & Caribbean` = "Latino América & Caribe",
             `Middle East & North Africa` = 
               "Oriente Medio & Norte de Africa", 
             `North America` = "América del Norte", 
             `South Asia` = "Sur de Asia", 
             `Sub-Saharan Africa` = "África Sub-Sahariana") %>% 
  fmt_number(columns= 2:8, 
             decimals = 2,
             dec_mark = ",")
```

### 4.1.3 Media de ingresos públicos {.tabset}

El siguiente indicador que trabajaremos es la media de ingresos públicos por región. Este indicador es un buena aproximación del gasto de estos países, puesto que mayores ingresos suele ir acompañado de mayor gasto. Además, frecuentemente los países más seguros son aquellos en los que la presión fiscal es más alta. Esto se debe, entre otros factores, a una mejor dotación de medios para los cuerpos de seguridad.

#### **Gráfico**

A la hora de describir la evolución de una variable es habitual el uso de gráficos de líneas. No obstante, existen otras formas muy útiles de representar la variación de un indicador a lo largo del tiempo. En este caso, hemos hecho uso de un boxplot. En él, podemos obsercar la media de los ingresos públicos por cada región, además del primer y tercer cuartil. Finalmente, también observamos cada una de las observaciones para cada año.

```{r, fig.width=9, fig.height=7}
media_regiones <- paises %>% group_by(region, year) %>%
  summarise(media_corrupción = mean(corruption_index, na.rm = TRUE),
            media_homicidios = mean(homicide_rate, na.rm = TRUE),
            media_militar = mean(total_military, na.rm = TRUE),
            media_gasto = mean(totalgr, na.rm= TRUE)) %>%
  ungroup() %>% mutate(year = as.numeric(year))

media_regiones %>% 
  select(region, year, media_gasto) %>%
  filter(!year == is.na(year)) %>% 
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x= region, y= media_gasto)) +
  geom_boxplot() + 
  geom_jitter(aes(color= year), size= 2) +
  scale_x_discrete(labels = c("Asia del Este\n&\nPacífico",
                              "Europa\n&\nAsia Central",
                              "Latino América\n&\nCaribe",
                              "Oriente Medio\n&\nNorte de Africa",
                              "América\ndel\nNorte", 
                              "Sur\nde\nAsia",
                              "África\nSub-Sahariana")) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(title = "Porcentaje ingresos públicos por región",
       subtitle = "De 1993 a 2019",
       x= "Región",
       y= "Ingresos públicos (%PIB)",
       color = "Año") +
  theme_ipsum() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.title.x = element_text(size = 12, face = "bold"),
        axis.title.y = element_text(size = 12, face = "bold"),
        legend.title = element_text(face = "bold", hjust = 0.5))
```

Cabe destacar las grandes diferencias que existen entre las regiones en lo referente a sus políticas fiscales. Mientras en los países europeos existe una importante presión fiscal, en regiones como el sur de Asía esta presión fiscal se reduce prácticamente a la mitad.

Por otro lado, otro aspecto a destacar es la dispersión de esta variable a lo largo de los años. Curiosamente, esta dispersión es menor para las regiones cuya presión fiscal es muy alta o muy baja. Y es mayor para las regiones cuyo nivel medio se encuentra entre ambos extremos.

Terminando con esta sección, la principal conclusión obtenida es la importante relación que existe entre ingresos públicos y riqueza. Puesto que podemos observar, son las regiones más ricas las que obtienen mayores ingresos públicos. Mientras que en la otra cara de la moneda, aquellas regiones más pobres son las que presentan un menor nivel.

#### **Tabla**

```{r}
media_regiones %>% #gtTable
  select(region, year, media_gasto) %>%
  filter(!year %in% c(2019, NA)) %>% 
  pivot_wider(names_from = "region", values_from = "media_gasto") %>%
  gt(rowname_col = "year") %>% 
  tab_header(title = md("Gasto público por regiones"),
             subtitle = md("De 1993 a 2018")) %>% 
  tab_options(heading.background.color = "sienna") %>%
  tab_options(heading.title.font.size = 25,
              heading.subtitle.font.size = 20,
              column_labels.font.weight =  "bold",
              heading.align = "center") %>% 
  tab_options(table.align = "center") %>% 
  cols_align(align = "center") %>% 
  cols_label(`East Asia & Pacific` = "Asia del Este & Pacífico",
             `Europe & Central Asia` = "Europa & Asia Central", 
             `Latin America & Caribbean` = "Latino América & Caribe",
             `Middle East & North Africa` = 
               "Oriente Medio & Norte de Africa", 
             `North America` = "América del Norte", 
             `South Asia` = "Sur de Asia", 
             `Sub-Saharan Africa` = "África Sub-Sahariana") %>% 
  fmt_percent(columns= 2:8, 
             decimals = 2)
```

### 4.1.4 Número medio de militares {.tabset}

Para terminar con el análisis por regiones, nos fijaremos en la dimensión de los ejércitos que conforman los diferentes países de cada región. Para ello, obtendremos el número total de militares de cada región y lo representaremos en el mapa que se muestra a continuación.

#### **Gráfico**

```{r}
media_regiones <- paises %>% 
  select(region, country_name, total_military) %>% 
  group_by(region, country_name) %>% 
  summarise(media_militar = mean(total_military, na.rm = TRUE)) %>%
  ungroup() %>% group_by(region) %>%  
  mutate(media_militar = mean(media_militar, na.rm = TRUE)) %>%
  mutate(iso2 = countrycode::countrycode(
    sourcevar = country_name, origin = "country.name",
    destination =  "iso2c", warn = FALSE), .after = country_name) 

mapa_mundo <- map_data("world") %>%
  mutate(iso2 = countrycode::countrycode(
    sourcevar = region, origin = "country.name",
    destination =  "iso2c", warn = FALSE), .after = region) 

paises_mapa <- full_join(mapa_mundo, media_regiones, 
                         by= c("iso2"="iso2"))

a <- paises_mapa %>%
  ggplot() +
  geom_polygon(aes( x= long, y = lat, group = group,
                    fill = region.y), color = "black") +
  labs(title = "Número total de militares por región",
    fill = "Regiones") +
  scale_fill_discrete(breaks = c("East Asia & Pacific", 
                                 "Europe & Central Asia", 
                                 "Latin America & Caribbean",
                                 "Middle East & North Africa", 
                                 "North America", "South Asia",
                                 "Sub-Saharan Africa"), 
                      labels = c("Asia del Este\n& Pacífico",
                                 "Europa\n& Asia Central", 
                                 "Latino América\n& Caribe", 
                                 "Oriente Medio\n& Norte de Africa",
                                 "América\ndel Norte", 
                                 "Sur\nde Asia",
                                 "África\nSub-Sahariana")) +
  theme_minimal() +
  theme(plot.title = element_text(size = 15, face = "bold", 
                                  hjust = 0.5),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(colour= "black", size= 1, 
                                        fill = "lightblue2"),
        legend.title = element_text(face= "bold"),
        legend.position = "bottom",
        legend.direction = "horizontal") +
  annotate("text", x= 95, y= 62, label = "123.550", size= 6,
           fontface=2, color= "brown") +
  annotate("text", x= 180, y= 10, label = "421.262", size= 6,
           fontface=2, color= "red") +
  annotate("text", x= -110, y= -10, label = "80.469", size= 6,
           fontface=2, color = "seagreen") +
  annotate("text", x= 72, y= -5, label = "516.730", size= 5,
           fontface=2, color = "purple") +
  annotate("text", x= -45, y= 30, label = "178.468", size= 5,
           fontface=2, color = "turquoise4") +
  annotate("text", x= -170, y= 40, label = "792.325", size= 6,
           fontface=2, color = "blue") +
  annotate("text", x= 20, y= -40, label = "38.301", size= 6,
           fontface=2, color = "magenta") +
  coord_fixed (xlim= c(-200,200),
               ylim= c(-58,90),
               ratio = 1.3) 

a
```

Sin embargo, la obtención de este dato nos crea la duda de conocer la dimensión de los ejércitos de cada país. Puesto que al agregar el número total de militares de cada país por región, perdemos la información sobre qué países realizan una mayor inversión en personal militar frente al resto. Además, para conocer si un país se encuentra fuertemente militarizado hemos de tener en cuenta su población. Por ello, la proporción de militares respecto a la población total nos ayudará más adelante a conocer la dimensión relativa de los ejércitos.

#### **Tabla**

```{r}
paises %>% select(region, country_name, total_military) %>%
  group_by(region, country_name) %>% 
  summarise(media_militar = mean(total_military, na.rm = TRUE)) %>%
  ungroup() %>% group_by(region) %>%  
  summarise(media_militar = mean(media_militar, na.rm = TRUE)) %>%
  ungroup() %>% mutate(region = case_when(
  region == "East Asia & Pacific" ~ "Asia del Este & Pacífico",
  region == "Europe & Central Asia" ~ "Europa & Asia Central", 
  region == "Latin America & Caribbean" ~ "Latino América & Caribe", 
  region == "Middle East & North Africa" ~ 
    "Oriente Medio & Norte de Africa", 
  region == "North America" ~ "América del Norte", 
  region == "South Asia" ~ "Sur de Asia", 
  region == "Sub-Saharan Africa" ~ "África Sub-Sahariana")) %>% 
  gt(rowname_col = "region") %>% 
  tab_header(title = md("Media de militares por región"),
             subtitle = md("De 1993 a 2019")) %>% 
  tab_options(heading.background.color = "orange") %>%
  tab_options(heading.title.font.size = 25,
              heading.subtitle.font.size = 20,
              column_labels.font.weight =  "bold",
              heading.align = "center") %>% 
  tab_options(table.align = "center") %>% 
  cols_align(align = "center") %>% 
  cols_label(`media_militar` = "Media número de militares") %>% 
  fmt_number(columns= 2, 
             decimals = 0,
             sep_mark = ".")
```

## 4.2 Análisis por países

A la hora de realizar un análisis por países hemos de ser conscientes del gran número de observaciones de las que disponemos. Existen alrededor de 200 países en el mundo. Por lo que la visualización de los datos de cada uno de estos países en un mismo gráfico se puede tornar un problema a la hora de representarlos. Por ello, en esta sección se mostraran los los países más relevantes par cada indicador en cuestión, o en otras palabras, nos centraremos en aquellos países que mejor nos ayuden a entender la información del dataset.

### 4.2.1 Número de militares por país

Comenzaremos donde lo dejamos antes. Para conocer qué países tienen un mayor número de militares respecto a su población, dividimos el número total de militares para cada país en cada año y calculamos su media. El resultado lo podemos mostrar en el siguiente mapa.

```{r}
#cuartiles <- descr(ejercito$mili_pc)

ejercito <- paises %>% 
  select(country_name, year, total_military, population) %>%
  drop_na(total_military, population) %>% 
  mutate(mili_pc = total_military/population) %>%
  group_by(country_name) %>% mutate(mili_pc = mean(mili_pc)) %>%
  mutate(mili_pc = case_when(
    mili_pc <= 0.0025272261 ~ 1,
    mili_pc > 0.0025272261 & mili_pc < 0.0049017440 ~ 2, 
    mili_pc > 0.0049017440 & mili_pc < 0.0084707455 ~ 3,
    mili_pc >= 0.0084707455  ~ 4,
    is.na(mili_pc) ~ 0)) %>% 
  mutate(country_name = ifelse(
    country_name == "SÃ£o TomÃ© and Principe",
    "São Tomé and Principe", country_name)) %>% 
  mutate(iso2 = countrycode::countrycode(
    sourcevar = country_name, origin = "country.name",
    destination =  "iso2c", warn = FALSE), .after = country_name) %>%
  mutate(mili_pc = as.character(mili_pc))

mapa_mundo <- map_data("world") %>% 
  mutate(iso2 = countrycode::countrycode(
    sourcevar = region, origin = "country.name",
    destination =  "iso2c", warn = FALSE), .after = region) 

paises_mapa2 <- full_join(mapa_mundo, ejercito, by= c("iso2"="iso2"))

l <- paises_mapa2 %>%
  ggplot() +
  geom_polygon(aes( x= long, y = lat, group = group, fill = mili_pc),
               color = "black") +
  scale_fill_discrete(breaks = c(4, 3, 2, 1, 0), 
                      labels= c("n > 0.84%", 
                                "0.49% < n < 0.84%",
                                "0.25% < n < 0.49%", "n < 0.25%",
                                "Sin datos")) +
  labs(
    title = "Porcentaje de militares por país",
    subtitle = "Media del periodo 1993-2019",
    fill = "Porcentaje de militares"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(size = 15, face = "bold",
                                  hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_text(face = "bold"),
        legend.position = "bottom",
        legend.direction = "vertical",
        panel.background = element_rect(colour= "black", size= 1,
                                        fill ="lightblue2")) +
  coord_fixed (xlim= c(-200,200),
               ylim= c(-58,90),
               ratio = 1.3) 

l

```

Los intervalos calculados para la representación del mapa han sido obtenidos de los cuartiles de la variable *mili_pc*. Sin embargo, entre en tercer cuartil y el valor más alto existe una gran dispersión. Por ello, resulta interesante conocer cuál es el porcentaje de militares en los países más militarizados.

```{r}
ejercito2 <- paises %>% 
  select(country_name, year, total_military, population) %>% 
  drop_na(total_military, population) %>% 
  mutate(mili_pc = total_military/population) %>% 
  group_by(country_name) %>% summarise(mili_pc = mean(mili_pc)) %>% 
  slice_max(order_by = mili_pc, n= 5) %>% 
  mutate(country_name = forcats::as_factor(country_name)) %>% 
  mutate(country_name = forcats::fct_reorder(
    country_name, mili_pc, .desc = FALSE))

a <- ggplot(ejercito2) + 
  geom_col(aes(x=country_name, y= mili_pc), fill = "sienna") +
  scale_y_continuous(limits = c(0, 0.06), 
                     breaks = seq(0, 0.06, 0.02), 
                     labels = scales::percent_format(accuracy = 1)) +
  scale_x_discrete(labels = c("Brunei", "Israel",
                              "Singapur", "Corea del Norte",
                              "Eritrea")) +
  labs(title = "Top 5 países con mayor\nporcentaje de militares",
       x= "",
       y="") +
  coord_flip() +
  theme_ipsum() +
  theme(plot.title = element_text(hjust = 0.5))

dd <- ggplotly(a, width = 600, height = 520)

htmltools::div(dd, align = "center")
```

### 4.2.2 Tasa de desempleo

Otro de los indicadores de los que disponemos es de la tasa de desempleo. A continuación, visualizaremos cuáles son los países que de media han mantenido un mayor y un menor nivel de desempleo a lo largo del periodo analizado.

####  {.tabset}

##### **Mayor desempleo**

```{r}
desemp_max <- paises %>% group_by(country_name) %>% 
  mutate(unemployment_rate = unemployment_rate/100) %>% 
  summarise(desemp = mean(unemployment_rate)) %>% drop_na() %>% 
  slice_max(order_by = desemp, n= 5)

desemp_max %>% #gtTable
  mutate(country_name = case_when(
    country_name == "North Macedonia" ~ "Macedonia del Norte",
    country_name == "Lesotho" ~ "Lesoto",
    country_name == "South Africa" ~ "Sudáfrica",
    country_name == "Bosnia and Herzegovina" ~ 
      "Bosnia & Herzegovina",
    country_name == "Eswatini" ~ "Suazilandia")) %>% 
  gt(rowname_col = "country_name") %>% 
  tab_header(title = md("Top 5 mayor tasa de desempleo"),
             subtitle = md("De 1993 a 2019")) %>% 
  tab_options(heading.background.color = "tan2") %>% 
  tab_options(heading.title.font.size = 25, 
              heading.subtitle.font.size = 20,  
              column_labels.font.weight =  "bold", 
              heading.align = "center") %>% 
  tab_options(table.align = "center") %>% 
  cols_align(align = "center") %>% 
  cols_label(desemp = "Desempleo medio") %>% 
  fmt_percent(columns= 2, 
             decimals = 2,
             dec_mark = ",")
```

##### **Menor desempleo**

```{r}
desemp_min <- paises %>% group_by(country_name) %>% 
  mutate(unemployment_rate = unemployment_rate/100) %>% 
  summarise(desemp = mean(unemployment_rate)) %>% drop_na() %>% 
  slice_min(order_by = desemp, n= 5) 

desemp_min %>% #gtTable
  mutate(country_name = ifelse(
    country_name == "Cambodia", "Camboya", country_name)) %>%
  gt(rowname_col = "country_name") %>% 
  tab_header(title = md("Top 5 menor tasa de desempleo"),
             subtitle = md("De 1993 a 2019")) %>% 
  tab_options(heading.background.color = "tan2") %>% 
  tab_options(heading.title.font.size = 25, 
              heading.subtitle.font.size = 20,  
              column_labels.font.weight =  "bold", 
              heading.align = "center") %>% 
  tab_options(table.align = "center") %>% 
  cols_align(align = "center") %>% 
  cols_label(desemp = "Desempleo medio") %>% 
  fmt_percent(columns= 2, 
              decimals = 2,
              dec_mark = ",")
```

#### 

Como podemos observar, existe una gran diferencia entre los países con mayor y menor desempleo. Cabe preguntarnos como ha evolucionado este indicador a lo largo del periodo para cada grupo de países.

```{r}
b <- paises %>% 
  select(country_name, year, unemployment_rate) %>%  
  mutate(country_name = case_when(
    country_name == "North Macedonia" ~ "Macedonia del Norte",
    country_name == "Lesotho" ~ "Lesoto",
    country_name == "South Africa" ~ "Sudáfrica",
    country_name == "Bosnia and Herzegovina" ~ 
      "Bosnia & Herzegovina",
    country_name == "Eswatini" ~ "Suazilandia",
    country_name == "Cambodia" ~ "Camboya",
    TRUE ~ country_name)) %>% 
  filter(country_name %in% c("Myanmar", "Camboya",
                             "Rwanda", "Bahrain", "Qatar",
                             "Macedonia del Norte", "Lesoto",
                             "Sudáfrica", "Bosnia & Herzegovina",
                             "Suazilandia")) %>% 
  mutate(unemployment_rate = unemployment_rate/100) %>% 
  ggplot(aes(x= year, y= unemployment_rate, color= country_name)) +
  geom_line(size = 1.2) +
  scale_y_continuous(limits = c(0, 0.4),
                     labels = scales::percent_format(accuracy = 1)) +
  scale_color_discrete(labels = c("Bahrain", "Bosnia\n& Herzegovina",
                                  "Camboya", "Lesoto", 
                                  "Macedonia\ndel Norte", "Myanmar",
                                  "Qatar", "Rwanda", "Suazilandia",
                                  "Sudáfrica")) +
  scale_color_viridis_d() +
  labs(title = "Evolución del TOP 5\nmayor y menor tasa de desempleo",
       x = "Tasa de desempleo",
       y = "Año",
       color = "Países") +
  theme_ipsum() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        legend.title = element_text(face = "bold"))

pp <- ggplotly(b, width = 600, height = 500)

htmltools::div(pp, align = "center" )
```

Como podíamos imaginar, los países con bajas tasas de desempleo han matenido constante este indicador a lo largo del periodo, mientras que los países con un desempleo mayor presentan una mayor variabilidad en este indicador.

### 4.2.3 Kilogramos de pesca según la población

Diversas causas o motivos pueden estar detrás de la piratería. Un indicador que nos puede ayudar a entender este tipo de ataques en las costas de un país es la cantidad de pesca per cápita de un país. Este indicador nos muestra cuál es la importancia que tiene esta actividad para los países. Una forma visual de mostrar estos datos es a través de un gráfico "wordcloud".

```{r, out.width = "100%"}
library(wordcloud2)

pesca <- paises %>% 
  mutate(fish = total_fisheries_per_ton*1000/population) %>% 
  group_by(country_name) %>% 
  summarise(fish_pc = mean(fish, na.rm = TRUE)) %>% 
  mutate(fish_pc = round(fish_pc, digits = 2)) %>% 
  mutate(country_name = case_when(
    country_name == "Greenland" ~ "Groenlandia",
    country_name == "Iceland" ~ "Islandia",
    country_name == "Marshall Islands" ~ "Islas Marshall",
    country_name == "Maldives" ~ "Maldivas",
    country_name == "Faroe Islands" ~ "Islas Faroe",
    country_name == "St. Vincent and the Grenadines" ~ 
      "San Vicente y las Granadinas", 
    country_name == "Norway" ~ "Noruega",
    TRUE ~ country_name)) %>% 
  slice_max(order_by = fish_pc, n=200)

wordcloud2(pesca, shape= "diamond", size = 0.8)
```

Claramente, observamos que las Islas Feroe, Islandia y Groenlandia son los países en los que más kilogramos por habitante se pesca, seguidos de lejos por otros países como Noruega, las Islas Marshall o las Seychelles. No obstante, llama la atención que los tres principales territores en los cuáles la pesca es una de las principales actividades sean dos territorios autónomos del Reino de Dinamarca (Las Islas Feroe y Groenlandia) y un país con un pasado vinculado a este reino, como es Islandia.

### 4.2.4 PIB per capita

Para terminar con esta sección, prestaremos especial atención al PIB per cápita y al PIB industrial per cápita. Como bien sabemos, el PIB per cápita es uno de los indicadores más usados para medir la riqueza de un país. Este mide la producción de un país por cada habitante. De esta forma, es posible realizar comparaciones entre países de distinta dimensión y población. Por otra parte, el PIB industrial nos indica a qué porcentaje del PIB contribuye la industria de un país. Resulta interesante conocer cuál es la relación entre ambas variables.

```{r}
gdp_pc <- paises %>% group_by(country_name) %>% 
  mutate(ind_pc = industryofgdp*GDP) %>% 
  select(country_name, year, region, GDP, ind_pc) %>%  
  drop_na(ind_pc)  

gdp_pc %>% ggplot(aes(x= GDP, y= ind_pc)) +
  geom_point(color = "salmon2", size = 2) +
  scale_color_discrete(labels = c("Asia del Este\n& Pacífico",
                                  "Europa\n& Asia Central",
                                  "Latino América\n& Caribe",
                                  "Oriente Medio\n& Norte de Africa",
                                  "América\ndel Norte",
                                  "Sur\nde Asia",
                                  "África\nSub-Sahariana")) + 
  theme_minimal() +
  transition_states(year) +
  labs(title = "Evolución del PIB industrial per capita
en función del PIB per capita\n Year : {closest_state}", 
       y = "PIB industrial per capita",
       x = "PIB per capita",
       color = "Regiones") +
  theme(plot.title = element_text(size = 20, hjust = 0.5,
                                  face = "bold"),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        legend.title = element_text(face = "bold", hjust = 0.5))
```

A medida que aumenta el PIB per cápita de un país, aumenta el PIB industrial per cápita. Esta conclusión parece obvia incluso antes de realizar el gráfico anterior. Sin embargo, del gráfico podemos extraer una idea bastante interesante. Conforme aumenta el PIB per cápita, ademas de aumentar el PIB per cápita industrial, también lo hace la varianza entre ambas variables. Este hecho nos indica que, aunque es cierto que el desarrollo industrial es un potente motor para el crecimiento, no es el único. Esto se debe a que conforme un país aumenta su riqueza otros sectores comienzan a ganar un mayor peso, como es el caso del sector servicios. Así, no es de extrañar que entre los países más ricos encontremos mayores diferencias en cuanto a la contribución que realiza su industria a la riqueza del país.

# 5. Conclusiones

```{r, include=FALSE}
library(readr)
library(tidyverse)
library(dplyr)
library("Hmisc")
library(corrplot)
```

```{r, include=FALSE}
country_codes <- read_csv("datos/country_codes.csv")

country_indicators <- read_csv("datos/country_indicators.csv")

pirate_attacks <- read_csv("datos/pirate_attacks.csv")

country_data <- full_join(country_codes, country_indicators, by = c("country" = "country"))

country_data <- country_data |> mutate(year = as.character(year))

pirate_attacks <- pirate_attacks |> separate(date, c("year", "month", "day"), "-" ) |>  mutate(attack_type = if_else(attack_type == "Boarding" , "Boarded", attack_type)) |> dplyr::select(-c(4, 8, 12:16, 18))

pirate_attacks <- pirate_attacks |> mutate(year = as.character(year))

rm(country_codes, country_indicators)

full_by_nearest <- full_join(pirate_attacks, country_data, by = c("nearest_country" = "country", "year" = "year"))|> filter(!is.na(longitude)) 
```

En este correlograma vemos los coeficientes de correlación entre las variables de las que disponemos de los países, más una nueva variable que es el número de ataques pirata ocurridos en las aguas de cada país en un determinado año. Como vemos, algunas relaciones son justamente las que podríamos esperar: los países más grandes suelen tener ejércitos más grandes, etc. Sin embargo, cuando ponemos el foco en la relación con el número de ataques, que es lo que más interesa en este trabajo, encontramos relaciones débiles de difícil interpretación. Creemos que esta vía de análisis carece de mayor interés.

```{r}
full_by_nearest <- full_join(pirate_attacks, country_data, by = c("nearest_country" = "country", "year" = "year"))|> filter(!is.na(longitude)) 

full_by_nearest <- full_by_nearest |> select(1,7,11:21) |>  group_by(nearest_country, year) |> mutate(nattacks = n()) |> ungroup() |> distinct()%>% select(where(is.numeric))

cor <- cor(full_by_nearest, use = "complete.obs")

corrplot(cor, type="upper", order="hclust", insig = "blank")
```

Para concluir, reconoceremos que este trabajo ha sido exitoso identificando en los datos ciertos patrones en los ataques pirata ya apreciados por la literatura, como la prevalencia de secuestros en la costa de África o el movimiento de las zonas calientes de Asia a África. No ha habido el mismo éxito buscando correlaciones con las variables de las que disponemos de los países, lo cual no quiere decir, a nuestro juicio, que no existan otras maneras de enriquecer este análisis.

# 6. Bibliografía

::: {#refs}
:::

<br><br>

```{r, echo = FALSE}
sessioninfo::session_info() %>% details::details(summary = 'Información de mi R-sesión:') 
```

<br><br>

::: {.tocify-extend-page data-unique="tocify-extend-page" style="height: 0;"}
:::
